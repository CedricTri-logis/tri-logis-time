default_platform(:android)

platform :android do
  desc "Build and upload to Google Play closed testing (alpha)"
  lane :alpha do
    sh("cd ../.. && flutter build appbundle --release")
    upload_to_play_store(
      track: "alpha",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Build and upload to Google Play open testing (beta)"
  lane :beta do
    sh("cd ../.. && flutter build appbundle --release")
    upload_to_play_store(
      track: "beta",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Check current version code on alpha track"
  lane :check_status do
    version_codes = google_play_track_version_codes(
      track: "alpha"
    )
    UI.important("ALPHA_VERSION_CODES:#{version_codes.join(',')}")
  end

  desc "Build and upload to Google Play production (draft for manual review)"
  lane :production do
    sh("cd ../.. && flutter build appbundle --release")
    upload_to_play_store(
      track: "production",
      release_status: "draft",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
